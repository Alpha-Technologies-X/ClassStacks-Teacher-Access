<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Stacks - Teacher Dashboard</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --danger: #e63946;
            --success: #2a9d8f;
            --warning: #f4a261;
            --dark: #212529;
            --light: #f8f9fa;
            --sidebar: #2c3e50;
            --sidebar-hover: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fb;
            color: var(--dark);
        }
        
        /* Authentication Styles */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
        }
        
        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid #e1e5ee;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5ee;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .btn {
            padding: 14px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: var(--secondary);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e6893a;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        
        .error-message {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: #ffeaea;
            border-radius: 8px;
            display: none;
        }
        
        .success-message {
            color: var(--success);
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: #e8f5e8;
            border-radius: 8px;
            display: none;
        }
        
        /* Dashboard Layout */
        .dashboard {
            display: none;
        }
        
        .dashboard-header {
            background: white;
            padding: 0 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .sidebar {
            background: var(--sidebar);
            color: white;
            width: 250px;
            height: calc(100vh - 70px);
            position: fixed;
            top: 70px;
            left: 0;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-item:hover {
            background: var(--sidebar-hover);
        }
        
        .sidebar-item.active {
            background: var(--primary);
        }
        
        .main-content {
            margin-left: 250px;
            margin-top: 70px;
            padding: 30px;
            min-height: calc(100vh - 70px);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .content-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 4px solid var(--primary);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.95rem;
        }
        
        /* Content Cards */
        .content-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e1e5ee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-body {
            padding: 25px;
        }
        
        /* Class Management */
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .class-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid #e1e5ee;
            position: relative;
        }
        
        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .class-name {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .class-code {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .class-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .class-stats {
            display: flex;
            gap: 15px;
        }
        
        .class-stat {
            text-align: center;
            flex: 1;
        }
        
        .class-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .class-stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        .class-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        /* Student Management */
        .students-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .students-table th, .students-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5ee;
        }
        
        .students-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .students-table tr:hover {
            background: #f8f9fa;
        }
        
        .student-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-online {
            background: #e7f7e9;
            color: var(--success);
        }
        
        .status-offline {
            background: #f0f0f0;
            color: #666;
        }
        
        .status-locked {
            background: #ffeaea;
            color: var(--danger);
        }
        
        .student-actions {
            display: flex;
            gap: 5px;
        }
        
        /* Parent Connections */
        .parent-connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .parent-connection-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            border-left: 4px solid var(--success);
        }
        
        .connection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .connection-student {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .connection-code {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .connection-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }
        
        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-connected {
            background: #e7f7e9;
            color: var(--success);
        }
        
        .status-pending {
            background: #fff3cd;
            color: var(--warning);
        }
        
        /* Bypass Codes */
        .bypass-codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .bypass-code-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            border-left: 4px solid var(--warning);
        }
        
        .bypass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .bypass-code {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .bypass-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }
        
        .bypass-usage {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .bypass-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Connection Codes */
        .connection-codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .connection-code-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            border-left: 4px solid var(--primary);
        }
        
        .connection-code-display {
            font-family: monospace;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            letter-spacing: 3px;
        }
        
        .connection-code-student {
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        /* Schedule Management */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .schedule-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            border-left: 4px solid var(--success);
        }
        
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .schedule-class {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .schedule-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }
        
        .schedule-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-active {
            background: #e7f7e9;
            color: var(--success);
        }
        
        .status-inactive {
            background: #f0f0f0;
            color: #666;
        }
        
        /* School Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .settings-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
        }
        
        .settings-section {
            margin-bottom: 25px;
        }
        
        .settings-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e5ee;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5ee;
        }
        
        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: var(--danger);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-item span {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .class-grid, .parent-connections-grid, .bypass-codes-grid, .connection-codes-grid, .schedule-grid, .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>üè´ Class Stacks</h1>
                <p>Educational Browser System</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="schoolTab" onclick="showAuthTab('school')">School Admin</div>
                <div class="auth-tab" id="teacherTab" onclick="showAuthTab('teacher')">Teacher Login</div>
                <div class="auth-tab" id="parentTab" onclick="showAuthTab('parent')">Parent Login</div>
            </div>
            
            <!-- School Admin Login Form -->
            <div id="schoolAuth">
                <div class="form-group">
                    <label for="schoolEmail">Email Address</label>
                    <input type="email" id="schoolEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="schoolPassword">Password</label>
                    <input type="password" id="schoolPassword" placeholder="Enter your password" required>
                </div>
                
                <button class="btn" onclick="loginSchool()">Login as School Admin</button>
                
                <div class="auth-toggle">
                    <a href="#" onclick="showSchoolRegistration()">Don't have an account? Register</a>
                </div>
            </div>
            
            <!-- Teacher Login Form -->
            <div id="teacherAuth" style="display: none;">
                <div class="form-group">
                    <label for="teacherEmail">Email Address</label>
                    <input type="email" id="teacherEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="teacherPassword">Password</label>
                    <input type="password" id="teacherPassword" placeholder="Enter your password" required>
                </div>
                
                <button class="btn" onclick="loginTeacher()">Login as Teacher</button>
                
                <div class="auth-toggle">
                    <a href="#" onclick="showTeacherRegistration()">Don't have an account? Register</a>
                </div>
            </div>
            
            <!-- Parent Login Form -->
            <div id="parentAuth" style="display: none;">
                <div class="form-group">
                    <label for="parentEmail">Email Address</label>
                    <input type="email" id="parentEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="parentPassword">Password</label>
                    <input type="password" id="parentPassword" placeholder="Enter your password" required>
                </div>
                
                <button class="btn" onclick="loginParent()">Login as Parent</button>
                
                <div class="auth-toggle">
                    <a href="#" onclick="showParentRegistration()">Don't have an account? Register</a>
                </div>
            </div>
            
            <!-- School Registration Form -->
            <div id="schoolRegistration" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 20px;">Create School Account</h2>
                
                <div class="form-group">
                    <label for="schoolName">School Name</label>
                    <input type="text" id="schoolName" placeholder="Enter your school name" required>
                </div>
                
                <div class="form-group">
                    <label for="schoolType">School Type</label>
                    <select id="schoolType" required>
                        <option value="">Select school type</option>
                        <option value="elementary">Elementary School</option>
                        <option value="middle">Middle School</option>
                        <option value="high">High School</option>
                        <option value="college">College/University</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="adminName">Administrator Name</label>
                    <input type="text" id="adminName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="adminEmail">Email Address</label>
                    <input type="email" id="adminEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" placeholder="Create a password" required>
                </div>
                
                <button class="btn btn-success" onclick="registerSchool()">Create School Account</button>
                
                <div class="auth-toggle">
                    <a href="#" onclick="showSchoolLogin()">Already have an account? Login</a>
                </div>
            </div>
            
            <!-- Teacher Registration Form -->
            <div id="teacherRegistration" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 20px;">Teacher Registration</h2>
                
                <div class="form-group">
                    <label for="teacherName">Full Name</label>
                    <input type="text" id="teacherName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="teacherRegEmail">Email Address</label>
                    <input type="email" id="teacherRegEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="teacherRegPassword">Password</label>
                    <input type="password" id="teacherRegPassword" placeholder="Create a password" required>
                </div>
                
                <div class="form-group">
                    <label for="schoolNameTeacher">School Name</label>
                    <input type="text" id="schoolNameTeacher" placeholder="Enter your school name" required>
                </div>
                
                <button class="btn btn-success" onclick="registerTeacher()">Create Teacher Account</button>
                
                <div class="auth-toggle">
                    <a href="#" onclick="showTeacherLogin()">Already have an account? Login</a>
                </div>
            </div>
            
            <!-- Parent Registration Form -->
            <div id="parentRegistration" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 20px;">Parent Registration</h2>
                
                <div class="form-group">
                    <label for="parentName">Full Name</label>
                    <input type="text" id="parentName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="parentRegEmail">Email Address</label>
                    <input type="email" id="parentRegEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="parentRegPassword">Password</label>
                    <input type="password" id="parentRegPassword" placeholder="Create a password" required>
                </div>
                
                <div class="form-group">
                    <label for="studentConnectionCode">Student Connection Code</label>
                    <input type="text" id="studentConnectionCode" placeholder="Enter code from teacher" required>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        Ask your child's teacher for the connection code
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="registerParent()">Create Parent Account</button>
                
                <div class="auth-toggle">
                    <a href="#" onclick="showParentLogin()">Already have an account? Login</a>
                </div>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>
    </div>
    
    <!-- Teacher Dashboard -->
    <div class="dashboard" id="teacherDashboard">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="logo">üè´ Class Stacks</div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">T</div>
                    <div>
                        <div style="font-weight: 600;" id="userName">Teacher Name</div>
                        <div style="font-size: 0.8rem; color: #666;" id="userRole">Teacher</div>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="logout()" style="padding: 8px 15px;">Logout</button>
            </div>
        </div>
        
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li class="sidebar-item active" onclick="showDashboardView('overview')">
                    <span>üìä</span> <span>Overview</span>
                </li>
                <li class="sidebar-item" onclick="showDashboardView('classes')">
                    <span>üë®‚Äçüè´</span> <span>My Classes</span>
                </li>
                <li class="sidebar-item" onclick="showDashboardView('students')">
                    <span>üë®‚Äçüéì</span> <span>Students</span>
                </li>
                <li class="sidebar-item" onclick="showDashboardView('schedules')">
                    <span>üìÖ</span> <span>Class Schedules</span>
                </li>
                <li class="sidebar-item" onclick="showDashboardView('parentConnections')">
                    <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> <span>Parent Connections</span>
                </li>
                <li class="sidebar-item" onclick="showDashboardView('bypassCodes')">
                    <span>üîì</span> <span>Bypass Codes</span>
                </li>
                <li class="sidebar-item" onclick="showDashboardView('connectionCodes')">
                    <span>üîó</span> <span>Connection Codes</span>
                </li>
                <li class="sidebar-item" id="schoolSettingsTab" style="display: none;" onclick="showDashboardView('schoolSettings')">
                    <span>‚öôÔ∏è</span> <span>School Settings</span>
                </li>
            </ul>
        </div>
        
        <div class="main-content">
            <!-- Overview View -->
            <div class="dashboard-view" id="overviewView">
                <div class="content-header">
                    <div class="content-title">Dashboard Overview</div>
                    <button class="btn" onclick="showCreateClassModal()" style="width: auto;">Create New Class</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="overviewClasses">0</div>
                        <div class="stat-label">My Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overviewStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overviewActive">0</div>
                        <div class="stat-label">Active Now</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overviewParents">0</div>
                        <div class="stat-label">Parent Connections</div>
                    </div>
                </div>
                
                <div class="content-card">
                    <div class="card-header">
                        <div class="card-title">Recent Activity</div>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <p>No recent activity</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Classes View -->
            <div class="dashboard-view" id="classesView" style="display: none;">
                <div class="content-header">
                    <div class="content-title">My Classes</div>
                    <button class="btn" onclick="showCreateClassModal()" style="width: auto;">Create New Class</button>
                </div>
                
                <div class="class-grid" id="classesList">
                    <!-- Classes will be listed here -->
                </div>
            </div>
            
            <!-- Students View -->
            <div class="dashboard-view" id="studentsView" style="display: none;">
                <div class="content-header">
                    <div class="content-title">Students</div>
                    <div>
                        <button class="btn" onclick="showCreateBypassCodeModal()" style="width: auto; margin-right: 10px;">Create Bypass Code</button>
                        <button class="btn" onclick="showCreateConnectionCodeModal()" style="width: auto;">Create Connection Code</button>
                    </div>
                </div>
                
                <div class="content-card">
                    <div class="card-header">
                        <div class="card-title">All Students</div>
                        <button class="btn" onclick="showAddStudentModal()" style="width: auto;">Add Student to Class</button>
                    </div>
                    <div class="card-body">
                        <table class="students-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Class</th>
                                    <th>Status</th>
                                    <th>Last Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsList">
                                <!-- Students will be listed here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Schedules View -->
            <div class="dashboard-view" id="schedulesView" style="display: none;">
                <div class="content-header">
                    <div class="content-title">Class Schedules</div>
                    <button class="btn" onclick="showCreateScheduleModal()" style="width: auto;">Create Schedule</button>
                </div>
                
                <div class="schedule-grid" id="schedulesList">
                    <!-- Schedules will be listed here -->
                </div>
            </div>
            
            <!-- Parent Connections View -->
            <div class="dashboard-view" id="parentConnectionsView" style="display: none;">
                <div class="content-header">
                    <div class="content-title">Parent Connections</div>
                    <button class="btn" onclick="showCreateParentCodeModal()" style="width: auto;">Generate Parent Code</button>
                </div>
                
                <div class="parent-connections-grid" id="parentConnectionsList">
                    <!-- Parent connections will be listed here -->
                </div>
            </div>
            
            <!-- Bypass Codes View -->
            <div class="dashboard-view" id="bypassCodesView" style="display: none;">
                <div class="content-header">
                    <div class="content-title">Bypass Codes</div>
                    <button class="btn" onclick="showCreateBypassCodeModal()" style="width: auto;">Create Bypass Code</button>
                </div>
                
                <div class="bypass-codes-grid" id="bypassCodesList">
                    <!-- Bypass codes will be listed here -->
                </div>
            </div>
            
            <!-- Connection Codes View -->
            <div class="dashboard-view" id="connectionCodesView" style="display: none;">
                <div class="content-header">
                    <div class="content-title">Connection Codes</div>
                    <button class="btn" onclick="showCreateConnectionCodeModal()" style="width: auto;">Create Connection Code</button>
                </div>
                
                <div class="connection-codes-grid" id="connectionCodesList">
                    <!-- Connection codes will be listed here -->
                </div>
            </div>
            
            <!-- School Settings View -->
            <div class="dashboard-view" id="schoolSettingsView" style="display: none;">
                <div class="content-header">
                    <div class="content-title">School Settings</div>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-card">
                        <div class="settings-section">
                            <div class="settings-section-title">School Information</div>
                            <div class="form-group">
                                <label for="schoolNameSettings">School Name</label>
                                <input type="text" id="schoolNameSettings" placeholder="School Name">
                            </div>
                            <div class="form-group">
                                <label for="schoolCodeSettings">School Code</label>
                                <input type="text" id="schoolCodeSettings" placeholder="School Code" readonly>
                            </div>
                            <button class="btn" onclick="updateSchoolInfo()">Update School Info</button>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">Website Restrictions</div>
                            <div class="form-group">
                                <label for="blockedSites">Blocked Websites (one per line)</label>
                                <textarea id="blockedSites" rows="6" placeholder="youtube.com&#10;facebook.com&#10;instagram.com"></textarea>
                            </div>
                            <button class="btn" onclick="updateBlockedSites()">Update Blocked Sites</button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <div class="settings-section">
                            <div class="settings-section-title">Global Settings</div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="allowBrowsing"> Allow browsing outside of class time
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="requireStudentNames"> Require student first and last names
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="enableScreenshots"> Enable automatic screenshots
                                </label>
                            </div>
                            <button class="btn" onclick="updateGlobalSettings()">Update Global Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="createClassModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Class</div>
                <button class="modal-close" onclick="closeModal('createClassModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label for="className">Class Name</label>
                <input type="text" id="className" placeholder="e.g., Math Grade 5">
            </div>
            
            <div class="form-group">
                <label for="classSubject">Subject</label>
                <input type="text" id="classSubject" placeholder="e.g., Mathematics">
            </div>
            
            <div class="form-group">
                <label for="classGrade">Grade Level</label>
                <input type="text" id="classGrade" placeholder="e.g., Grade 5">
            </div>
            
            <button class="btn btn-success" onclick="createClass()">Create Class</button>
        </div>
    </div>
    
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Student to Class</div>
                <button class="modal-close" onclick="closeModal('addStudentModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label for="studentSearch">Search Student by Name</label>
                <input type="text" id="studentSearch" placeholder="Enter student first or last name" onkeyup="searchStudents()">
                <div id="studentSearchResults" style="max-height: 200px; overflow-y: auto; margin-top: 10px; display: none;">
                    <!-- Search results will appear here -->
                </div>
            </div>
            
            <div class="form-group">
                <label for="studentClassSelect">Select Class</label>
                <select id="studentClassSelect">
                    <!-- Classes will be populated here -->
                </select>
            </div>
            
            <button class="btn btn-success" onclick="addStudentToClass()">Add Student</button>
        </div>
    </div>
    
    <div class="modal" id="createScheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Class Schedule</div>
                <button class="modal-close" onclick="closeModal('createScheduleModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label for="scheduleClassSelect">Select Class</label>
                <select id="scheduleClassSelect">
                    <!-- Classes will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="scheduleDays">Days of Week</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label><input type="checkbox" name="scheduleDay" value="monday"> Mon</label>
                    <label><input type="checkbox" name="scheduleDay" value="tuesday"> Tue</label>
                    <label><input type="checkbox" name="scheduleDay" value="wednesday"> Wed</label>
                    <label><input type="checkbox" name="scheduleDay" value="thursday"> Thu</label>
                    <label><input type="checkbox" name="scheduleDay" value="friday"> Fri</label>
                    <label><input type="checkbox" name="scheduleDay" value="saturday"> Sat</label>
                    <label><input type="checkbox" name="scheduleDay" value="sunday"> Sun</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="scheduleStartTime">Start Time</label>
                <input type="time" id="scheduleStartTime" required>
            </div>
            
            <div class="form-group">
                <label for="scheduleEndTime">End Time</label>
                <input type="time" id="scheduleEndTime" required>
            </div>
            
            <button class="btn btn-success" onclick="createSchedule()">Create Schedule</button>
        </div>
    </div>
    
    <div class="modal" id="createParentCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Generate Parent Connection Code</div>
                <button class="modal-close" onclick="closeModal('createParentCodeModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label for="parentStudentSelect">Select Student</label>
                <select id="parentStudentSelect">
                    <!-- Students will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="parentCodeExpiry">Code Expiry</label>
                <select id="parentCodeExpiry">
                    <option value="7">7 days</option>
                    <option value="30">30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                </select>
            </div>
            
            <div id="parentCodeDisplay" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <h3>Parent Connection Code</h3>
                <div style="font-family: monospace; font-size: 1.5rem; font-weight: bold; margin: 10px 0;" id="generatedParentCode"></div>
                <p style="font-size: 0.9rem; color: #666;">Share this code with the parent to connect to the student's account.</p>
            </div>
            
            <button class="btn btn-success" onclick="generateParentCode()">Generate Code</button>
            <button class="btn" onclick="closeModal('createParentCodeModal')" style="margin-top: 10px; display: none;" id="closeParentCodeBtn">Finish</button>
        </div>
    </div>
    
    <div class="modal" id="createBypassCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Bypass Code</div>
                <button class="modal-close" onclick="closeModal('createBypassCodeModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label for="bypassCodeName">Code Name (Optional)</label>
                <input type="text" id="bypassCodeName" placeholder="e.g., Research Project">
            </div>
            
            <div class="form-group">
                <label for="bypassCodeExpiry">Code Expiry</label>
                <select id="bypassCodeExpiry">
                    <option value="1">1 hour</option>
                    <option value="3">3 hours</option>
                    <option value="6">6 hours</option>
                    <option value="24">1 day</option>
                    <option value="168">1 week</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="bypassCodeMaxUsage">Maximum Usage</label>
                <select id="bypassCodeMaxUsage">
                    <option value="1">1 use</option>
                    <option value="5" selected>5 uses</option>
                    <option value="10">10 uses</option>
                    <option value="25">25 uses</option>
                    <option value="100">100 uses</option>
                </select>
            </div>
            
            <div id="bypassCodeDisplay" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <h3>Bypass Code Created</h3>
                <div style="font-family: monospace; font-size: 1.5rem; font-weight: bold; margin: 10px 0;" id="generatedBypassCode"></div>
                <p style="font-size: 0.9rem; color: #666;">Share this code with students to temporarily bypass website restrictions.</p>
            </div>
            
            <button class="btn btn-success" onclick="generateBypassCode()">Generate Code</button>
            <button class="btn" onclick="closeModal('createBypassCodeModal')" style="margin-top: 10px; display: none;" id="closeBypassCodeBtn">Finish</button>
        </div>
    </div>
    
    <div class="modal" id="createConnectionCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Connection Code</div>
                <button class="modal-close" onclick="closeModal('createConnectionCodeModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label for="connectionStudentSelect">Select Student</label>
                <select id="connectionStudentSelect">
                    <!-- Students will be populated here -->
                </select>
            </div>
            
            <div id="connectionCodeDisplay" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <h3>Student Connection Code</h3>
                <div style="font-family: monospace; font-size: 1.5rem; font-weight: bold; margin: 10px 0;" id="generatedConnectionCode"></div>
                <p style="font-size: 0.9rem; color: #666;">Share this code with the student. They can enter it at browser://connect to connect their browser.</p>
            </div>
            
            <button class="btn btn-success" onclick="generateConnectionCode()">Generate Code</button>
            <button class="btn" onclick="closeModal('createConnectionCodeModal')" style="margin-top: 10px; display: none;" id="closeConnectionCodeBtn">Finish</button>
        </div>
    </div>
    
    <div class="modal" id="deleteClassModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Delete Class</div>
                <button class="modal-close" onclick="closeModal('deleteClassModal')">√ó</button>
            </div>
            
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h3>Are you sure?</h3>
                <p>You are about to delete the class <strong id="deleteClassName"></strong>. This action cannot be undone.</p>
                <p style="color: var(--danger); font-weight: 600;">All students in this class will be disconnected.</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmDeleteClass()" style="flex: 1;">Delete Class</button>
                <button class="btn" onclick="closeModal('deleteClassModal')" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="studentControlModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Student Control</div>
                <button class="modal-close" onclick="closeModal('studentControlModal')">√ó</button>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üë®‚Äçüéì</div>
                <h3 id="studentControlName">Student Name</h3>
                <p id="studentControlClass">Class: Unknown</p>
            </div>
            
            <div class="form-group">
                <label for="studentMessage">Send Message</label>
                <textarea id="studentMessage" placeholder="Type a message to send to the student..." rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="studentUrl">Open Website</label>
                <input type="text" id="studentUrl" placeholder="https://example.com">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="sendStudentMessage()" style="flex: 1;">Send Message</button>
                <button class="btn" onclick="openStudentWebsite()" style="flex: 1;">Open Website</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-warning" onclick="lockStudentBrowser()" style="flex: 1;">Lock Browser</button>
                <button class="btn btn-success" onclick="unlockStudentBrowser()" style="flex: 1;">Unlock Browser</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn" onclick="requestStudentScreenshot()" style="flex: 1;">Request Screenshot</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentView = 'overview';
        let classToDelete = null;
        let studentToControl = null;
        let selectedStudentForClass = null;
        
        // Initialize the application
        function initializeApp() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                if (currentUser.role === 'teacher' || currentUser.role === 'school') {
                    showTeacherDashboard();
                }
            }
            
            // Initialize data structure if it doesn't exist
            if (!localStorage.getItem('classStacksData')) {
                const initialData = {
                    schools: {},
                    teachers: {},
                    parents: {},
                    classes: {},
                    students: {},
                    parentCodes: {},
                    bypassCodes: {},
                    schedules: {},
                    schoolSettings: {},
                    activityLogs: {},
                    lastUpdated: Date.now()
                };
                localStorage.setItem('classStacksData', JSON.stringify(initialData));
            }
        }
        
        // Show authentication tab
        function showAuthTab(tab) {
            document.getElementById('schoolTab').classList.remove('active');
            document.getElementById('teacherTab').classList.remove('active');
            document.getElementById('parentTab').classList.remove('active');
            
            document.getElementById('schoolAuth').style.display = 'none';
            document.getElementById('teacherAuth').style.display = 'none';
            document.getElementById('parentAuth').style.display = 'none';
            document.getElementById('schoolRegistration').style.display = 'none';
            document.getElementById('teacherRegistration').style.display = 'none';
            document.getElementById('parentRegistration').style.display = 'none';
            
            if (tab === 'school') {
                document.getElementById('schoolTab').classList.add('active');
                document.getElementById('schoolAuth').style.display = 'block';
            } else if (tab === 'teacher') {
                document.getElementById('teacherTab').classList.add('active');
                document.getElementById('teacherAuth').style.display = 'block';
            } else {
                document.getElementById('parentTab').classList.add('active');
                document.getElementById('parentAuth').style.display = 'block';
            }
        }
        
        // Show school registration
        function showSchoolRegistration() {
            document.getElementById('schoolAuth').style.display = 'none';
            document.getElementById('schoolRegistration').style.display = 'block';
        }
        
        // Show school login
        function showSchoolLogin() {
            document.getElementById('schoolRegistration').style.display = 'none';
            document.getElementById('schoolAuth').style.display = 'block';
        }
        
        // Show teacher registration
        function showTeacherRegistration() {
            document.getElementById('teacherAuth').style.display = 'none';
            document.getElementById('teacherRegistration').style.display = 'block';
        }
        
        // Show teacher login
        function showTeacherLogin() {
            document.getElementById('teacherRegistration').style.display = 'none';
            document.getElementById('teacherAuth').style.display = 'block';
        }
        
        // Show parent registration
        function showParentRegistration() {
            document.getElementById('parentAuth').style.display = 'none';
            document.getElementById('parentRegistration').style.display = 'block';
        }
        
        // Show parent login
        function showParentLogin() {
            document.getElementById('parentRegistration').style.display = 'none';
            document.getElementById('parentAuth').style.display = 'block';
        }
        
        // Register a new school
        function registerSchool() {
            const schoolName = document.getElementById('schoolName').value;
            const schoolType = document.getElementById('schoolType').value;
            const adminName = document.getElementById('adminName').value;
            const adminEmail = document.getElementById('adminEmail').value;
            const adminPassword = document.getElementById('adminPassword').value;
            
            if (!schoolName || !schoolType || !adminName || !adminEmail || !adminPassword) {
                showError('Please fill in all required fields');
                return;
            }
            
            if (adminPassword.length < 6) {
                showError('Password must be at least 6 characters long');
                return;
            }
            
            const data = getSharedData();
            
            // Check if email already exists
            const existingUser = Object.values(data.schools).find(school => 
                school.email === adminEmail
            );
            
            if (existingUser) {
                showError('A school with this email already exists');
                return;
            }
            
            // Create school account
            const schoolId = 'school_' + Date.now();
            const schoolCode = generateSchoolCode();
            
            data.schools[schoolId] = {
                id: schoolId,
                name: schoolName,
                type: schoolType,
                adminName: adminName,
                email: adminEmail,
                password: adminPassword,
                role: 'school',
                schoolCode: schoolCode,
                created: Date.now()
            };
            
            // Initialize school settings
            data.schoolSettings[schoolId] = {
                blockedSites: ['youtube.com', 'facebook.com', 'instagram.com', 'tiktok.com'],
                allowBrowsing: true,
                requireStudentNames: true,
                enableScreenshots: true
            };
            
            // Save data
            saveSharedData(data);
            
            // Set current user
            currentUser = data.schools[schoolId];
            
            // Save to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Show success message and dashboard
            showSuccess('School account created successfully! School Code: ' + schoolCode);
            setTimeout(() => {
                showTeacherDashboard();
            }, 1500);
        }
        
        // Login as school
        function loginSchool() {
            const email = document.getElementById('schoolEmail').value;
            const password = document.getElementById('schoolPassword').value;
            
            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }
            
            const data = getSharedData();
            
            // Find school with matching credentials
            const school = Object.values(data.schools).find(s => 
                s.email === email && s.password === password
            );
            
            if (school) {
                currentUser = school;
                
                // Save to localStorage
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showTeacherDashboard();
            } else {
                showError('Invalid email or password');
            }
        }
        
        // Register a new teacher
        function registerTeacher() {
            const teacherName = document.getElementById('teacherName').value;
            const teacherEmail = document.getElementById('teacherRegEmail').value;
            const teacherPassword = document.getElementById('teacherRegPassword').value;
            const schoolName = document.getElementById('schoolNameTeacher').value;
            
            if (!teacherName || !teacherEmail || !teacherPassword || !schoolName) {
                showError('Please fill in all required fields');
                return;
            }
            
            if (teacherPassword.length < 6) {
                showError('Password must be at least 6 characters long');
                return;
            }
            
            const data = getSharedData();
            
            // Check if email already exists
            const existingUser = Object.values(data.teachers).find(teacher => 
                teacher.email === teacherEmail
            );
            
            if (existingUser) {
                showError('A teacher with this email already exists');
                return;
            }
            
            // Create teacher account
            const teacherId = 'teacher_' + Date.now();
            data.teachers[teacherId] = {
                id: teacherId,
                name: teacherName,
                email: teacherEmail,
                password: teacherPassword,
                school: schoolName,
                role: 'teacher',
                created: Date.now()
            };
            
            // Save data
            saveSharedData(data);
            
            // Set current user
            currentUser = data.teachers[teacherId];
            
            // Save to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Show success message and dashboard
            showSuccess('Teacher account created successfully!');
            setTimeout(() => {
                showTeacherDashboard();
            }, 1500);
        }
        
        // Login as teacher
        function loginTeacher() {
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;
            
            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }
            
            const data = getSharedData();
            
            // Find teacher with matching credentials
            const teacher = Object.values(data.teachers).find(t => 
                t.email === email && t.password === password
            );
            
            if (teacher) {
                currentUser = teacher;
                
                // Save to localStorage
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showTeacherDashboard();
            } else {
                showError('Invalid email or password');
            }
        }
        
        // Register as parent
        function registerParent() {
            const parentName = document.getElementById('parentName').value;
            const parentEmail = document.getElementById('parentRegEmail').value;
            const parentPassword = document.getElementById('parentRegPassword').value;
            const connectionCode = document.getElementById('studentConnectionCode').value;
            
            if (!parentName || !parentEmail || !parentPassword || !connectionCode) {
                showError('Please fill in all required fields');
                return;
            }
            
            if (parentPassword.length < 6) {
                showError('Password must be at least 6 characters long');
                return;
            }
            
            const data = getSharedData();
            
            // Check if email already exists
            const existingUser = Object.values(data.parents).find(parent => 
                parent.email === parentEmail
            );
            
            if (existingUser) {
                showError('A parent with this email already exists');
                return;
            }
            
            // Find parent code - FIXED: Check if parent code exists and is valid
            let parentCode = null;
            let studentId = null;
            
            // First check if it's a parent connection code
            parentCode = Object.values(data.parentCodes).find(code => 
                code.code === connectionCode && !code.used && Date.now() < code.expiry
            );
            
            if (parentCode) {
                studentId = parentCode.studentId;
            } else {
                // If not a parent code, check if it's a student connection code
                const student = Object.values(data.students).find(s => 
                    s.connectionCode === connectionCode
                );
                
                if (student) {
                    studentId = student.id;
                } else {
                    showError('Invalid or expired connection code');
                    return;
                }
            }
            
            // Create parent account
            const parentId = 'parent_' + Date.now();
            data.parents[parentId] = {
                id: parentId,
                name: parentName,
                email: parentEmail,
                password: parentPassword,
                role: 'parent',
                connectedStudents: [studentId],
                created: Date.now()
            };
            
            // Mark parent code as used if it was a parent code
            if (parentCode) {
                parentCode.used = true;
                parentCode.usedBy = parentId;
                parentCode.usedAt = Date.now();
            }
            
            // Save data
            saveSharedData(data);
            
            // Show success message
            showSuccess('Parent account created successfully! You can now login.');
            showParentLogin();
        }
        
        // Login as parent
        function loginParent() {
            const email = document.getElementById('parentEmail').value;
            const password = document.getElementById('parentPassword').value;
            
            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }
            
            const data = getSharedData();
            
            // Find parent with matching credentials
            const parent = Object.values(data.parents).find(p => 
                p.email === email && p.password === password
            );
            
            if (parent) {
                // For this demo, we'll just show a success message
                // In a real implementation, this would show the parent dashboard
                showSuccess('Parent login successful! Parent dashboard would open here.');
            } else {
                showError('Invalid email or password');
            }
        }
        
        // Show teacher dashboard
        function showTeacherDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('teacherDashboard').style.display = 'block';
            
            // Show school settings tab for school admins
            if (currentUser.role === 'school') {
                document.getElementById('schoolSettingsTab').style.display = 'block';
            }
            
            // Update dashboard with current data
            updateTeacherDashboard();
        }
        
        // Update teacher dashboard with current data
        function updateTeacherDashboard() {
            if (!currentUser) return;
            
            const data = getSharedData();
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userRole').textContent = currentUser.role === 'school' ? 'School Admin' : 'Teacher';
            
            // Update current view
            updateDashboardView();
        }
        
        // Show dashboard view
        function showDashboardView(view) {
            currentView = view;
            
            // Update sidebar active item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll('.dashboard-view').forEach(view => {
                view.style.display = 'none';
            });
            
            document.getElementById(view + 'View').style.display = 'block';
            
            // Update the view
            updateDashboardView();
        }
        
        // Update current dashboard view
        function updateDashboardView() {
            const data = getSharedData();
            
            switch (currentView) {
                case 'overview':
                    updateOverviewView(data);
                    break;
                case 'classes':
                    updateClassesView(data);
                    break;
                case 'students':
                    updateStudentsView(data);
                    break;
                case 'schedules':
                    updateSchedulesView(data);
                    break;
                case 'parentConnections':
                    updateParentConnectionsView(data);
                    break;
                case 'bypassCodes':
                    updateBypassCodesView(data);
                    break;
                case 'connectionCodes':
                    updateConnectionCodesView(data);
                    break;
                case 'schoolSettings':
                    updateSchoolSettingsView(data);
                    break;
            }
        }
        
        // Update overview view
        function updateOverviewView(data) {
            // Get teacher's classes
            const teacherClasses = Object.values(data.classes).filter(c => 
                c.teacherId === currentUser.id || currentUser.role === 'school'
            );
            
            // Get all students
            const allStudents = Object.values(data.students);
            
            // Count active students (online in last 30 seconds)
            const activeStudents = allStudents.filter(s => 
                s.lastActive && (Date.now() - s.lastActive) < 30000
            );
            
            // Count parent connections
            const parentConnections = Object.values(data.parentCodes).filter(code => 
                code.used
            ).length;
            
            // Update stats
            document.getElementById('overviewClasses').textContent = teacherClasses.length;
            document.getElementById('overviewStudents').textContent = allStudents.length;
            document.getElementById('overviewActive').textContent = activeStudents.length;
            document.getElementById('overviewParents').textContent = parentConnections;
            
            // Update recent activity
            updateRecentActivity(data);
        }
        
        // Update recent activity
        function updateRecentActivity(data) {
            const activityContainer = document.getElementById('recentActivity');
            activityContainer.innerHTML = '';
            
            // Get recent activity logs
            const allLogs = [];
            Object.values(data.activityLogs || {}).forEach(logs => {
                logs.forEach(log => {
                    allLogs.push(log);
                });
            });
            
            // Sort by timestamp (newest first)
            allLogs.sort((a, b) => b.timestamp - a.timestamp);
            
            // Get last 5 activities
            const recentLogs = allLogs.slice(0, 5);
            
            if (recentLogs.length === 0) {
                activityContainer.innerHTML = '<p>No recent activity</p>';
                return;
            }
            
            recentLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.style.padding = '10px 0';
                logElement.style.borderBottom = '1px solid #f0f0f0';
                
                const time = new Date(log.timestamp).toLocaleTimeString();
                logElement.innerHTML = `
                    <div style="font-weight: 500;">${log.action}</div>
                    <div style="font-size: 0.8rem; color: #666;">${time}</div>
                `;
                
                activityContainer.appendChild(logElement);
            });
        }
        
        // Update classes view
        function updateClassesView(data) {
            const classesList = document.getElementById('classesList');
            classesList.innerHTML = '';
            
            // Get teacher's classes
            const teacherClasses = Object.values(data.classes).filter(c => 
                c.teacherId === currentUser.id || currentUser.role === 'school'
            );
            
            if (teacherClasses.length === 0) {
                classesList.innerHTML = '<p>No classes created yet</p>';
                return;
            }
            
            teacherClasses.forEach(classItem => {
                // Count students in this class
                const classStudents = Object.values(data.students).filter(s => 
                    s.classCode === classItem.code
                );
                
                // Count active students
                const activeStudents = classStudents.filter(s => 
                    s.lastActive && (Date.now() - s.lastActive) < 30000
                );
                
                const classCard = document.createElement('div');
                classCard.className = 'class-card';
                
                classCard.innerHTML = `
                    <div class="class-actions">
                        <button class="action-btn delete-btn" onclick="showDeleteClassModal('${classItem.id}')" title="Delete Class">√ó</button>
                    </div>
                    <div class="class-header">
                        <div class="class-name">${classItem.name}</div>
                        <div class="class-code">${classItem.code}</div>
                    </div>
                    <div class="class-info">
                        ${classItem.subject} ‚Ä¢ ${classItem.grade}
                    </div>
                    <div class="class-stats">
                        <div class="class-stat">
                            <div class="class-stat-value">${classStudents.length}</div>
                            <div class="class-stat-label">Students</div>
                        </div>
                        <div class="class-stat">
                            <div class="class-stat-value">${activeStudents.length}</div>
                            <div class="stat-label">Active</div>
                        </div>
                    </div>
                `;
                
                classesList.appendChild(classCard);
            });
        }
        
        // Update students view
        function updateStudentsView(data) {
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '';
            
            // Get teacher's students
            const teacherStudents = Object.values(data.students).filter(s => {
                const studentClass = data.classes[s.classCode];
                return studentClass && (studentClass.teacherId === currentUser.id || currentUser.role === 'school');
            });
            
            if (teacherStudents.length === 0) {
                studentsList.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No students found</td></tr>';
                return;
            }
            
            teacherStudents.forEach(student => {
                const studentClass = data.classes[student.classCode];
                const isOnline = student.lastActive && (Date.now() - student.lastActive) < 30000;
                const isLocked = data.studentLocks && data.studentLocks[student.id];
                
                const statusClass = isLocked ? 'status-locked' : (isOnline ? 'status-online' : 'status-offline');
                const statusText = isLocked ? 'Locked' : (isOnline ? 'Online' : 'Offline');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${studentClass ? studentClass.name : student.classCode}</td>
                    <td><span class="student-status ${statusClass}">${statusText}</span></td>
                    <td>${student.lastActive ? new Date(student.lastActive).toLocaleTimeString() : 'Never'}</td>
                    <td>
                        <div class="student-actions">
                            <button class="btn" onclick="showStudentControlModal('${student.id}')" style="padding: 5px 10px;">Control</button>
                            <button class="btn btn-warning" onclick="lockStudent('${student.id}')" style="padding: 5px 10px;">Lock</button>
                            <button class="btn btn-success" onclick="unlockStudent('${student.id}')" style="padding: 5px 10px;">Unlock</button>
                        </div>
                    </td>
                `;
                
                studentsList.appendChild(row);
            });
        }
        
        // Update schedules view
        function updateSchedulesView(data) {
            const schedulesList = document.getElementById('schedulesList');
            schedulesList.innerHTML = '';
            
            // Get teacher's schedules
            const teacherSchedules = Object.values(data.schedules || {}).filter(schedule => {
                const scheduleClass = data.classes[schedule.classId];
                return scheduleClass && (scheduleClass.teacherId === currentUser.id || currentUser.role === 'school');
            });
            
            if (teacherSchedules.length === 0) {
                schedulesList.innerHTML = '<p>No schedules created yet</p>';
                return;
            }
            
            teacherSchedules.forEach(schedule => {
                const scheduleClass = data.classes[schedule.classId];
                const isActive = isScheduleActive(schedule);
                
                const scheduleCard = document.createElement('div');
                scheduleCard.className = 'schedule-card';
                
                scheduleCard.innerHTML = `
                    <div class="schedule-header">
                        <div class="schedule-class">${scheduleClass ? scheduleClass.name : 'Unknown Class'}</div>
                        <span class="schedule-status ${isActive ? 'status-active' : 'status-inactive'}">
                            ${isActive ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="schedule-info">
                        Days: ${schedule.days.join(', ')}<br>
                        Time: ${schedule.startTime} - ${schedule.endTime}<br>
                        Created: ${new Date(schedule.created).toLocaleDateString()}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-danger" onclick="deleteSchedule('${schedule.id}')" style="padding: 5px 10px;">Delete Schedule</button>
                    </div>
                `;
                
                schedulesList.appendChild(scheduleCard);
            });
        }
        
        // Update parent connections view
        function updateParentConnectionsView(data) {
            const parentConnectionsList = document.getElementById('parentConnectionsList');
            parentConnectionsList.innerHTML = '';
            
            // Get parent codes for this teacher's students
            const teacherStudents = Object.values(data.students).filter(s => {
                const studentClass = data.classes[s.classCode];
                return studentClass && (studentClass.teacherId === currentUser.id || currentUser.role === 'school');
            });
            
            const parentCodes = Object.values(data.parentCodes || {}).filter(code => 
                teacherStudents.some(s => s.id === code.studentId)
            );
            
            if (parentCodes.length === 0) {
                parentConnectionsList.innerHTML = '<p>No parent connections yet</p>';
                return;
            }
            
            parentCodes.forEach(code => {
                const student = data.students[code.studentId];
                const parent = code.usedBy ? data.parents[code.usedBy] : null;
                
                const connectionCard = document.createElement('div');
                connectionCard.className = 'parent-connection-card';
                
                connectionCard.innerHTML = `
                    <div class="connection-header">
                        <div class="connection-student">${student ? student.name : 'Unknown Student'}</div>
                        <div class="connection-code">${code.code}</div>
                    </div>
                    <div class="connection-info">
                        Class: ${student ? student.classCode : 'Unknown'}<br>
                        Created: ${new Date(code.created).toLocaleDateString()}<br>
                        Expires: ${new Date(code.expiry).toLocaleDateString()}
                    </div>
                    <div>
                        <span class="connection-status ${code.used ? 'status-connected' : 'status-pending'}">
                            ${code.used ? 'Connected' : 'Pending'}
                        </span>
                        ${parent ? `<div style="margin-top: 10px; font-size: 0.9rem;">Connected to: ${parent.name}</div>` : ''}
                    </div>
                `;
                
                parentConnectionsList.appendChild(connectionCard);
            });
        }
        
        // Update bypass codes view
        function updateBypassCodesView(data) {
            const bypassCodesList = document.getElementById('bypassCodesList');
            bypassCodesList.innerHTML = '';
            
            // Get bypass codes created by this teacher
            const teacherBypassCodes = Object.values(data.bypassCodes || {}).filter(code => 
                code.teacherId === currentUser.id || currentUser.role === 'school'
            );
            
            if (teacherBypassCodes.length === 0) {
                bypassCodesList.innerHTML = '<p>No bypass codes created yet</p>';
                return;
            }
            
            teacherBypassCodes.forEach(code => {
                const isExpired = Date.now() > code.expiry;
                const isUsedUp = code.usageCount >= code.maxUsage;
                
                const bypassCard = document.createElement('div');
                bypassCard.className = 'bypass-code-card';
                
                bypassCard.innerHTML = `
                    <div class="bypass-header">
                        <div class="bypass-code">${code.code}</div>
                        <div>
                            ${isExpired ? '<span style="color: var(--danger);">Expired</span>' : 
                              isUsedUp ? '<span style="color: var(--warning);">Used Up</span>' : 
                              '<span style="color: var(--success);">Active</span>'}
                        </div>
                    </div>
                    <div class="bypass-info">
                        ${code.name ? `<strong>${code.name}</strong><br>` : ''}
                        Created: ${new Date(code.created).toLocaleDateString()}<br>
                        Expires: ${new Date(code.expiry).toLocaleDateString()}
                    </div>
                    <div class="bypass-usage">
                        <span>Usage: ${code.usageCount || 0}/${code.maxUsage}</span>
                        <span>${Math.floor((code.expiry - Date.now()) / (1000 * 60 * 60))}h remaining</span>
                    </div>
                    <div class="bypass-actions">
                        <button class="btn" onclick="copyBypassCode('${code.code}')" style="padding: 5px 10px;">Copy</button>
                        <button class="btn btn-danger" onclick="deleteBypassCode('${code.code}')" style="padding: 5px 10px;">Delete</button>
                    </div>
                `;
                
                bypassCodesList.appendChild(bypassCard);
            });
        }
        
        // Update connection codes view
        function updateConnectionCodesView(data) {
            const connectionCodesList = document.getElementById('connectionCodesList');
            connectionCodesList.innerHTML = '';
            
            // Get connection codes for this teacher's students
            const teacherStudents = Object.values(data.students).filter(s => {
                const studentClass = data.classes[s.classCode];
                return studentClass && (studentClass.teacherId === currentUser.id || currentUser.role === 'school');
            });
            
            // Find students with connection codes
            const studentsWithCodes = teacherStudents.filter(s => s.connectionCode);
            
            if (studentsWithCodes.length === 0) {
                connectionCodesList.innerHTML = '<p>No connection codes generated yet</p>';
                return;
            }
            
            studentsWithCodes.forEach(student => {
                const connectionCard = document.createElement('div');
                connectionCard.className = 'connection-code-card';
                
                connectionCard.innerHTML = `
                    <div class="connection-code-student">${student.name}</div>
                    <div class="connection-code-display">${student.connectionCode}</div>
                    <div style="text-align: center;">
                        <p>Share this code with the student</p>
                        <p style="font-size: 0.9rem; color: #666;">Student can enter this code at browser://connect</p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" onclick="copyConnectionCode('${student.connectionCode}')" style="flex: 1;">Copy Code</button>
                        <button class="btn btn-danger" onclick="deleteConnectionCode('${student.id}')" style="flex: 1;">Delete Code</button>
                    </div>
                `;
                
                connectionCodesList.appendChild(connectionCard);
            });
        }
        
        // Update school settings view
        function updateSchoolSettingsView(data) {
            if (currentUser.role !== 'school') return;
            
            const schoolSettings = data.schoolSettings[currentUser.id] || {};
            
            // Update school info
            document.getElementById('schoolNameSettings').value = currentUser.name || '';
            document.getElementById('schoolCodeSettings').value = currentUser.schoolCode || '';
            
            // Update blocked sites
            document.getElementById('blockedSites').value = (schoolSettings.blockedSites || []).join('\n');
            
            // Update global settings
            document.getElementById('allowBrowsing').checked = schoolSettings.allowBrowsing !== false;
            document.getElementById('requireStudentNames').checked = schoolSettings.requireStudentNames !== false;
            document.getElementById('enableScreenshots').checked = schoolSettings.enableScreenshots !== false;
        }
        
        // Class management functions
        function showCreateClassModal() {
            document.getElementById('createClassModal').style.display = 'flex';
        }
        
        function createClass() {
            const name = document.getElementById('className').value;
            const subject = document.getElementById('classSubject').value;
            const grade = document.getElementById('classGrade').value;
            
            if (!name || !subject || !grade) {
                alert('Please fill in all required fields');
                return;
            }
            
            const data = getSharedData();
            
            // Generate class code
            const classCode = generateClassCode();
            
            // Create class
            data.classes[classCode] = {
                id: classCode,
                name: name,
                teacherId: currentUser.id,
                subject: subject,
                grade: grade,
                code: classCode,
                created: Date.now()
            };
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            // Close modal and show success
            closeModal('createClassModal');
            showSuccess('Class created successfully! Code: ' + classCode);
            
            // Clear form
            document.getElementById('className').value = '';
            document.getElementById('classSubject').value = '';
            document.getElementById('classGrade').value = '';
        }
        
        function showDeleteClassModal(classId) {
            const data = getSharedData();
            const classItem = data.classes[classId];
            
            if (classItem) {
                classToDelete = classId;
                document.getElementById('deleteClassName').textContent = classItem.name;
                document.getElementById('deleteClassModal').style.display = 'flex';
            }
        }
        
        function confirmDeleteClass() {
            if (!classToDelete) return;
            
            const data = getSharedData();
            
            // Remove class
            delete data.classes[classToDelete];
            
            // Remove students from this class
            Object.keys(data.students).forEach(studentId => {
                if (data.students[studentId].classCode === classToDelete) {
                    delete data.students[studentId];
                }
            });
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            // Close modal and show success
            closeModal('deleteClassModal');
            showSuccess('Class deleted successfully!');
            
            classToDelete = null;
        }
        
        // Student management functions
        function showAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'flex';
            
            // Populate class dropdown
            const classSelect = document.getElementById('studentClassSelect');
            classSelect.innerHTML = '';
            
            const data = getSharedData();
            const teacherClasses = Object.values(data.classes).filter(c => 
                c.teacherId === currentUser.id || currentUser.role === 'school'
            );
            
            teacherClasses.forEach(classItem => {
                const option = document.createElement('option');
                option.value = classItem.id;
                option.textContent = classItem.name;
                classSelect.appendChild(option);
            });
        }
        
        function searchStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const resultsContainer = document.getElementById('studentSearchResults');
            
            if (!searchTerm) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const data = getSharedData();
            const allStudents = Object.values(data.students);
            
            // Filter students by name
            const matchingStudents = allStudents.filter(student => 
                student.name.toLowerCase().includes(searchTerm)
            );
            
            resultsContainer.innerHTML = '';
            
            if (matchingStudents.length === 0) {
                resultsContainer.innerHTML = '<p>No students found</p>';
            } else {
                matchingStudents.forEach(student => {
                    const studentElement = document.createElement('div');
                    studentElement.style.padding = '10px';
                    studentElement.style.borderBottom = '1px solid #e1e5ee';
                    studentElement.style.cursor = 'pointer';
                    studentElement.innerHTML = `
                        <strong>${student.name}</strong>
                        <div style="font-size: 0.8rem; color: #666;">${student.classCode || 'No class'}</div>
                    `;
                    studentElement.onclick = () => {
                        selectedStudentForClass = student.id;
                        document.getElementById('studentSearch').value = student.name;
                        resultsContainer.style.display = 'none';
                    };
                    resultsContainer.appendChild(studentElement);
                });
            }
            
            resultsContainer.style.display = 'block';
        }
        
        function addStudentToClass() {
            if (!selectedStudentForClass) {
                alert('Please select a student');
                return;
            }
            
            const classId = document.getElementById('studentClassSelect').value;
            if (!classId) {
                alert('Please select a class');
                return;
            }
            
            const data = getSharedData();
            const classItem = data.classes[classId];
            
            if (classItem && data.students[selectedStudentForClass]) {
                // Add student to class
                data.students[selectedStudentForClass].classCode = classId;
                
                // Save data
                saveSharedData(data);
                
                // Update dashboard
                updateDashboardView();
                
                // Close modal and show success
                closeModal('addStudentModal');
                showSuccess('Student added to class successfully!');
                
                // Reset selection
                selectedStudentForClass = null;
                document.getElementById('studentSearch').value = '';
            } else {
                alert('Error adding student to class');
            }
        }
        
        // Schedule management functions
        function showCreateScheduleModal() {
            document.getElementById('createScheduleModal').style.display = 'flex';
            
            // Populate class dropdown
            const classSelect = document.getElementById('scheduleClassSelect');
            classSelect.innerHTML = '';
            
            const data = getSharedData();
            const teacherClasses = Object.values(data.classes).filter(c => 
                c.teacherId === currentUser.id || currentUser.role === 'school'
            );
            
            teacherClasses.forEach(classItem => {
                const option = document.createElement('option');
                option.value = classItem.id;
                option.textContent = classItem.name;
                classSelect.appendChild(option);
            });
        }
        
        function createSchedule() {
            const classId = document.getElementById('scheduleClassSelect').value;
            const startTime = document.getElementById('scheduleStartTime').value;
            const endTime = document.getElementById('scheduleEndTime').value;
            
            if (!classId || !startTime || !endTime) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Get selected days
            const dayCheckboxes = document.querySelectorAll('input[name="scheduleDay"]:checked');
            const selectedDays = Array.from(dayCheckboxes).map(cb => cb.value);
            
            if (selectedDays.length === 0) {
                alert('Please select at least one day');
                return;
            }
            
            const data = getSharedData();
            
            // Create schedule
            const scheduleId = 'schedule_' + Date.now();
            data.schedules[scheduleId] = {
                id: scheduleId,
                classId: classId,
                days: selectedDays,
                startTime: startTime,
                endTime: endTime,
                created: Date.now()
            };
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            // Close modal and show success
            closeModal('createScheduleModal');
            showSuccess('Schedule created successfully!');
        }
        
        function deleteSchedule(scheduleId) {
            const data = getSharedData();
            
            // Remove schedule
            delete data.schedules[scheduleId];
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            showSuccess('Schedule deleted successfully!');
        }
        
        function isScheduleActive(schedule) {
            const now = new Date();
            const currentDay = now.getDay();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM format
            
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const currentDayName = dayNames[currentDay];
            
            return schedule.days.includes(currentDayName) && 
                   currentTime >= schedule.startTime && 
                   currentTime <= schedule.endTime;
        }
        
        // Student control functions
        function showStudentControlModal(studentId) {
            const data = getSharedData();
            const student = data.students[studentId];
            
            if (student) {
                studentToControl = studentId;
                document.getElementById('studentControlName').textContent = student.name;
                document.getElementById('studentControlClass').textContent = `Class: ${student.classCode}`;
                document.getElementById('studentControlModal').style.display = 'flex';
            }
        }
        
        function sendStudentMessage() {
            if (!studentToControl) return;
            
            const message = document.getElementById('studentMessage').value;
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            const data = getSharedData();
            
            // Create messages object if it doesn't exist
            if (!data.messages) data.messages = {};
            if (!data.messages[studentToControl]) data.messages[studentToControl] = [];
            
            // Add message
            data.messages[studentToControl].push({
                text: message,
                from: currentUser.name,
                timestamp: Date.now()
            });
            
            // Save data
            saveSharedData(data);
            
            // Clear message field
            document.getElementById('studentMessage').value = '';
            
            showSuccess('Message sent to student!');
        }
        
        function openStudentWebsite() {
            if (!studentToControl) return;
            
            const url = document.getElementById('studentUrl').value;
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            const data = getSharedData();
            
            // Create teacher control object if it doesn't exist
            if (!data.teacherControl) data.teacherControl = {};
            
            // Set control command
            data.teacherControl[studentToControl] = {
                action: 'openTab',
                url: url,
                timestamp: Date.now()
            };
            
            // Save data
            saveSharedData(data);
            
            showSuccess('Website opened in student browser!');
        }
        
        function lockStudentBrowser() {
            if (!studentToControl) return;
            
            const data = getSharedData();
            
            // Create student locks object if it doesn't exist
            if (!data.studentLocks) data.studentLocks = {};
            
            // Lock student
            data.studentLocks[studentToControl] = true;
            
            // Save data
            saveSharedData(data);
            
            showSuccess('Student browser locked!');
        }
        
        function unlockStudentBrowser() {
            if (!studentToControl) return;
            
            const data = getSharedData();
            
            // Unlock student
            if (data.studentLocks) {
                delete data.studentLocks[studentToControl];
            }
            
            // Save data
            saveSharedData(data);
            
            showSuccess('Student browser unlocked!');
        }
        
        function requestStudentScreenshot() {
            if (!studentToControl) return;
            
            const data = getSharedData();
            
            // Create screenshots object if it doesn't exist
            if (!data.screenshots) data.screenshots = {};
            
            // Request screenshot
            data.screenshots[studentToControl] = {
                requested: true,
                timestamp: Date.now()
            };
            
            // Save data
            saveSharedData(data);
            
            showSuccess('Screenshot requested from student!');
        }
        
        function lockStudent(studentId) {
            const data = getSharedData();
            
            // Create student locks object if it doesn't exist
            if (!data.studentLocks) data.studentLocks = {};
            
            // Lock student
            data.studentLocks[studentId] = true;
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            showSuccess('Student browser locked!');
        }
        
        function unlockStudent(studentId) {
            const data = getSharedData();
            
            // Unlock student
            if (data.studentLocks) {
                delete data.studentLocks[studentId];
            }
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            showSuccess('Student browser unlocked!');
        }
        
        // Parent connection functions
        function showCreateParentCodeModal() {
            document.getElementById('createParentCodeModal').style.display = 'flex';
            
            // Populate student dropdown
            const studentSelect = document.getElementById('parentStudentSelect');
            studentSelect.innerHTML = '';
            
            const data = getSharedData();
            const teacherStudents = Object.values(data.students).filter(s => {
                const studentClass = data.classes[s.classCode];
                return studentClass && (studentClass.teacherId === currentUser.id || currentUser.role === 'school');
            });
            
            teacherStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name + ' (' + student.classCode + ')';
                studentSelect.appendChild(option);
            });
        }
        
        function generateParentCode() {
            const studentId = document.getElementById('parentStudentSelect').value;
            const expiryDays = parseInt(document.getElementById('parentCodeExpiry').value);
            
            if (!studentId) {
                alert('Please select a student');
                return;
            }
            
            const data = getSharedData();
            
            // Generate parent code
            const code = generateParentConnectionCode();
            
            // Create parent code
            data.parentCodes[code] = {
                code: code,
                studentId: studentId,
                teacherId: currentUser.id,
                created: Date.now(),
                expiry: Date.now() + (expiryDays * 24 * 60 * 60 * 1000),
                used: false
            };
            
            // Save data
            saveSharedData(data);
            
            // Display the code
            document.getElementById('generatedParentCode').textContent = code;
            document.getElementById('parentCodeDisplay').style.display = 'block';
            
            // Show finish button
            document.getElementById('closeParentCodeBtn').style.display = 'block';
            
            showSuccess('Parent connection code generated!');
        }
        
        // Bypass code functions
        function showCreateBypassCodeModal() {
            document.getElementById('createBypassCodeModal').style.display = 'flex';
        }
        
        function generateBypassCode() {
            const name = document.getElementById('bypassCodeName').value;
            const expiryHours = parseInt(document.getElementById('bypassCodeExpiry').value);
            const maxUsage = parseInt(document.getElementById('bypassCodeMaxUsage').value);
            
            const data = getSharedData();
            
            // Generate bypass code
            const code = generateBypassCodeString();
            
            // Create bypass code
            data.bypassCodes[code] = {
                code: code,
                name: name || null,
                teacherId: currentUser.id,
                created: Date.now(),
                expiry: Date.now() + (expiryHours * 60 * 60 * 1000),
                maxUsage: maxUsage,
                usageCount: 0
            };
            
            // Save data
            saveSharedData(data);
            
            // Display the code
            document.getElementById('generatedBypassCode').textContent = code;
            document.getElementById('bypassCodeDisplay').style.display = 'block';
            
            // Show finish button
            document.getElementById('closeBypassCodeBtn').style.display = 'block';
            
            showSuccess('Bypass code generated!');
        }
        
        function copyBypassCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showSuccess('Bypass code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        function deleteBypassCode(code) {
            const data = getSharedData();
            
            // Remove bypass code
            delete data.bypassCodes[code];
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            showSuccess('Bypass code deleted!');
        }
        
        // Connection code functions
        function showCreateConnectionCodeModal() {
            document.getElementById('createConnectionCodeModal').style.display = 'flex';
            
            // Populate student dropdown
            const studentSelect = document.getElementById('connectionStudentSelect');
            studentSelect.innerHTML = '';
            
            const data = getSharedData();
            const teacherStudents = Object.values(data.students).filter(s => {
                const studentClass = data.classes[s.classCode];
                return studentClass && (studentClass.teacherId === currentUser.id || currentUser.role === 'school');
            });
            
            teacherStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name + ' (' + student.classCode + ')';
                studentSelect.appendChild(option);
            });
        }
        
        function generateConnectionCode() {
            const studentId = document.getElementById('connectionStudentSelect').value;
            
            if (!studentId) {
                alert('Please select a student');
                return;
            }
            
            const data = getSharedData();
            
            // Generate connection code
            const code = generateConnectionCodeString();
            
            // Update student with connection code
            if (data.students[studentId]) {
                data.students[studentId].connectionCode = code;
            }
            
            // Save data
            saveSharedData(data);
            
            // Display the code
            document.getElementById('generatedConnectionCode').textContent = code;
            document.getElementById('connectionCodeDisplay').style.display = 'block';
            
            // Show finish button
            document.getElementById('closeConnectionCodeBtn').style.display = 'block';
            
            showSuccess('Connection code generated!');
        }
        
        function copyConnectionCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showSuccess('Connection code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        function deleteConnectionCode(studentId) {
            const data = getSharedData();
            
            // Remove connection code from student
            if (data.students[studentId]) {
                delete data.students[studentId].connectionCode;
            }
            
            // Save data
            saveSharedData(data);
            
            // Update dashboard
            updateDashboardView();
            
            showSuccess('Connection code deleted!');
        }
        
        // School settings functions
        function updateSchoolInfo() {
            if (currentUser.role !== 'school') return;
            
            const schoolName = document.getElementById('schoolNameSettings').value;
            
            if (!schoolName) {
                alert('Please enter a school name');
                return;
            }
            
            const data = getSharedData();
            
            // Update school name
            if (data.schools[currentUser.id]) {
                data.schools[currentUser.id].name = schoolName;
            }
            
            // Save data
            saveSharedData(data);
            
            // Update current user
            currentUser.name = schoolName;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Update dashboard
            updateTeacherDashboard();
            
            showSuccess('School information updated!');
        }
        
        function updateBlockedSites() {
            if (currentUser.role !== 'school') return;
            
            const blockedSitesText = document.getElementById('blockedSites').value;
            const blockedSites = blockedSitesText.split('\n')
                .map(site => site.trim())
                .filter(site => site.length > 0);
            
            const data = getSharedData();
            
            // Update school settings
            if (!data.schoolSettings[currentUser.id]) {
                data.schoolSettings[currentUser.id] = {};
            }
            
            data.schoolSettings[currentUser.id].blockedSites = blockedSites;
            
            // Save data
            saveSharedData(data);
            
            showSuccess('Blocked websites updated!');
        }
        
        function updateGlobalSettings() {
            if (currentUser.role !== 'school') return;
            
            const allowBrowsing = document.getElementById('allowBrowsing').checked;
            const requireStudentNames = document.getElementById('requireStudentNames').checked;
            const enableScreenshots = document.getElementById('enableScreenshots').checked;
            
            const data = getSharedData();
            
            // Update school settings
            if (!data.schoolSettings[currentUser.id]) {
                data.schoolSettings[currentUser.id] = {};
            }
            
            data.schoolSettings[currentUser.id].allowBrowsing = allowBrowsing;
            data.schoolSettings[currentUser.id].requireStudentNames = requireStudentNames;
            data.schoolSettings[currentUser.id].enableScreenshots = enableScreenshots;
            
            // Save data
            saveSharedData(data);
            
            showSuccess('Global settings updated!');
        }
        
        // Utility functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('teacherDashboard').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            showAuthTab('teacher');
        }
        
        function getSharedData() {
            const defaultData = {
                schools: {},
                teachers: {},
                parents: {},
                classes: {},
                students: {},
                parentCodes: {},
                bypassCodes: {},
                schedules: {},
                schoolSettings: {},
                activityLogs: {},
                lastUpdated: Date.now()
            };
            
            try {
                const stored = localStorage.getItem('classStacksData');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    return {...defaultData, ...parsed};
                }
            } catch (e) {
                console.error('Error parsing stored data:', e);
            }
            
            return defaultData;
        }
        
        function saveSharedData(data) {
            try {
                data.lastUpdated = Date.now();
                localStorage.setItem('classStacksData', JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Error saving data:', e);
                return false;
            }
        }
        
        function generateSchoolCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function generateClassCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function generateParentConnectionCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function generateBypassCodeString() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 10; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function generateConnectionCodeString() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
